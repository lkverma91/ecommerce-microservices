services:

  # ============================================================
  # INFRASTRUCTURE — Database (single instance, multiple DBs)
  # ============================================================

  postgres:
    image: postgres:16.2-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d:ro
    networks:
      - db-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # INFRASTRUCTURE — Messaging & Caching
  # ============================================================

  redis:
    image: redis:7.2-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - backend-net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - backend-net
    healthcheck:
      test: [ "CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/2181' 2>/dev/null && echo ok" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    restart: unless-stopped
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - backend-net
    healthcheck:
      test: [ "CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # INFRASTRUCTURE — Observability
  # ============================================================

  zipkin:
    image: openzipkin/zipkin:3.4
    container_name: zipkin
    restart: unless-stopped
    environment:
      STORAGE_TYPE: ${ZIPKIN_STORAGE_TYPE:-mem}
    networks:
      - backend-net
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:9411/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # PLATFORM — Service Discovery & Configuration
  # ============================================================

  eureka-server:
    build: ./eureka-server
    hostname: eureka-server
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
    networks:
      - backend-net
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8761/actuator/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  config-server:
    build: ./config-server
    hostname: config-server
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
      EUREKA_URI: http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - backend-net
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8888/actuator/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # APPLICATION SERVICES
  # ============================================================

  user-service:
    build: ./user-service
    hostname: user-service
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
      EUREKA_URI: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_HOSTNAME: user-service
      DATABASE_URL: jdbc:postgresql://postgres:5432/user_db
      DATABASE_USERNAME: ${POSTGRES_USER:-postgres}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      ZIPKIN_URL: http://zipkin:9411/api/v2/spans
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - backend-net
      - db-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  product-service:
    build: ./product-service
    hostname: product-service
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
      EUREKA_URI: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_HOSTNAME: product-service
      DATABASE_URL: jdbc:postgresql://postgres:5432/product_db
      DATABASE_USERNAME: ${POSTGRES_USER:-postgres}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      ZIPKIN_URL: http://zipkin:9411/api/v2/spans
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - backend-net
      - db-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  inventory-service:
    build: ./inventory-service
    hostname: inventory-service
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
      EUREKA_URI: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_HOSTNAME: inventory-service
      DATABASE_URL: jdbc:postgresql://postgres:5432/inventory_db
      DATABASE_USERNAME: ${POSTGRES_USER:-postgres}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      ZIPKIN_URL: http://zipkin:9411/api/v2/spans
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - backend-net
      - db-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  order-service:
    build: ./order-service
    hostname: order-service
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
      EUREKA_URI: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_HOSTNAME: order-service
      DATABASE_URL: jdbc:postgresql://postgres:5432/order_db
      DATABASE_USERNAME: ${POSTGRES_USER:-postgres}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      ZIPKIN_URL: http://zipkin:9411/api/v2/spans
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - backend-net
      - db-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  payment-service:
    build: ./payment-service
    hostname: payment-service
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
      EUREKA_URI: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_HOSTNAME: payment-service
      DATABASE_URL: jdbc:postgresql://postgres:5432/payment_db
      DATABASE_USERNAME: ${POSTGRES_USER:-postgres}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      ZIPKIN_URL: http://zipkin:9411/api/v2/spans
    depends_on:
      eureka-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - backend-net
      - db-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # EDGE — API Gateway & Frontend
  # ============================================================

  api-gateway:
    build: ./api-gateway
    hostname: api-gateway
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
      EUREKA_URI: http://eureka-server:8761/eureka/
      REDIS_HOST: redis
      REDIS_PORT: 6379
      ZIPKIN_URL: http://zipkin:9411/api/v2/spans
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET must be set}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:5173}
      RATE_LIMIT_REPLENISH: ${RATE_LIMIT_REPLENISH:-10}
      RATE_LIMIT_BURST: ${RATE_LIMIT_BURST:-20}
    depends_on:
      eureka-server:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - frontend-net
      - backend-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    build:
      context: ./frontend
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-/api}
    restart: unless-stopped
    depends_on:
      - api-gateway
    networks:
      - frontend-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================
# VOLUMES
# ============================================================
volumes:
  postgres_data:
  redis_data:

    # ============================================================
    # NETWORKS
    # ============================================================
networks:
  frontend-net:
    driver: bridge
  backend-net:
    driver: bridge
  db-net:
    driver: bridge
